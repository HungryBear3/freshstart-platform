// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User model for authentication
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?   // Hashed password
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Marketing Attribution (captured on signup)
  utmSource     String?   // google, facebook, influencer, youtube, etc.
  utmMedium     String?   // cpc, organic_social, email, referral, video
  utmCampaign   String?   // campaign name
  utmTerm       String?   // paid search keyword
  utmContent    String?   // ad/content variation

  // Relations
  accounts      Account[]
  sessions      Session[]
  questionnaires QuestionnaireResponse[]
  documents     Document[]
  caseInfo      CaseInfo?
  financialData FinancialData?
  children      Child[]
  parentingPlan ParentingPlan?
  subscription  Subscription?
  payments      Payment[]
  spouseFinancialRecords SpouseFinancialRecord[]

  @@map("users")
}

// NextAuth.js Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth.js Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// NextAuth.js VerificationToken model
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Questionnaire definitions (templates)
model Questionnaire {
  id          String   @id @default(cuid())
  name        String
  type        String   @unique // e.g., "petition", "financial_affidavit", "parenting_plan"
  description String?
  structure   Json     // Store questionnaire structure (sections, questions, conditional logic)
  isActive    Boolean  @default(true)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  responses QuestionnaireResponse[]

  @@map("questionnaires")
}

// Questionnaire responses
model QuestionnaireResponse {
  id             String   @id @default(cuid())
  userId         String
  questionnaireId String?
  formType       String   // e.g., "petition", "financial_affidavit", "parenting_plan"
  responses      Json     // Store questionnaire answers as JSON
  currentSection Int      @default(0) // Track progress through multi-section questionnaires
  status         String   @default("draft") // draft, completed, submitted
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionnaire Questionnaire? @relation(fields: [questionnaireId], references: [id], onDelete: SetNull)
  documents    Document[]

  @@map("questionnaire_responses")
}

// Generated documents
model Document {
  id                    String   @id @default(cuid())
  userId                String
  type                  String   // e.g., "petition", "financial_affidavit", "parenting_plan", "marital_settlement"
  fileName              String
  filePath              String?  // Path to stored document (legacy, for S3/cloud storage)
  content               String?  // Document content stored directly in DB (for serverless)
  mimeType              String   @default("text/plain") // MIME type for serving
  status                String   @default("draft") // draft, ready, filed, accepted, rejected
  generatedAt           DateTime @default(now())
  updatedAt             DateTime @updatedAt
  questionnaireResponseId String? // Links to source questionnaire response for edit/regenerate

  user                  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionnaireResponse QuestionnaireResponse? @relation(fields: [questionnaireResponseId], references: [id], onDelete: SetNull)

  @@map("documents")
}

// Case information and tracking
model CaseInfo {
  id          String   @id @default(cuid())
  userId      String   @unique
  caseNumber  String?
  courtName   String?
  county      String?
  judgeName   String?
  filingDate  DateTime?
  status      String   @default("not_filed")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  milestones Milestone[]
  deadlines  Deadline[]

  @@map("case_info")
}

// Case milestones
model Milestone {
  id          String   @id @default(cuid())
  caseInfoId  String
  title       String
  description String?
  date        DateTime
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())

  caseInfo CaseInfo @relation(fields: [caseInfoId], references: [id], onDelete: Cascade)

  @@map("milestones")
}

// Case deadlines
model Deadline {
  id          String   @id @default(cuid())
  caseInfoId  String
  title       String
  description String?
  dueDate     DateTime
  completed   Boolean  @default(false)
  reminderSent Boolean @default(false)
  createdAt   DateTime @default(now())

  caseInfo CaseInfo @relation(fields: [caseInfoId], references: [id], onDelete: Cascade)

  @@map("deadlines")
}

// Financial data - main container
model FinancialData {
  id          String   @id @default(cuid())
  userId      String   @unique
  formType    String   @default("short") // "short" or "long" Financial Affidavit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  income   IncomeSource[]
  expenses Expense[]
  assets   Asset[]
  debts    Debt[]

  @@map("financial_data")
}

// Income sources
model IncomeSource {
  id            String   @id @default(cuid())
  financialDataId String
  type          String   // "wages", "self_employment", "unemployment", "social_security", "pension", "investment", "rental", "other"
  source        String   // Description of income source (e.g., "ABC Company", "Freelance Design")
  amount        Decimal  @db.Decimal(10, 2)
  frequency     String   @default("monthly") // "weekly", "biweekly", "monthly", "yearly"
  startDate     DateTime?
  endDate       DateTime?
  isCurrent     Boolean  @default(true)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  financialData FinancialData @relation(fields: [financialDataId], references: [id], onDelete: Cascade)

  @@map("income_sources")
}

// Expenses (monthly)
model Expense {
  id            String   @id @default(cuid())
  financialDataId String
  category      String   // Illinois court categories: "housing", "utilities", "food", "transportation", "healthcare", "childcare", "education", "personal", "insurance", "taxes", "other"
  description   String   // Specific expense description
  amount        Decimal  @db.Decimal(10, 2)
  frequency     String   @default("monthly") // "weekly", "biweekly", "monthly", "yearly", "one_time"
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  financialData FinancialData @relation(fields: [financialDataId], references: [id], onDelete: Cascade)

  @@map("expenses")
}

// Assets
model Asset {
  id            String   @id @default(cuid())
  financialDataId String
  type          String   // "real_estate", "vehicle", "bank_account", "investment", "retirement", "business", "personal_property", "other"
  description   String   // Asset description (e.g., "2019 Toyota Camry", "Primary Residence")
  value         Decimal  @db.Decimal(10, 2)
  ownership     String   @default("individual") // "individual", "joint", "spouse"
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  financialData FinancialData @relation(fields: [financialDataId], references: [id], onDelete: Cascade)

  @@map("assets")
}

// Debts and liabilities
model Debt {
  id            String   @id @default(cuid())
  financialDataId String
  type          String   // "mortgage", "auto_loan", "credit_card", "student_loan", "personal_loan", "medical", "tax_debt", "other"
  creditor      String   // Creditor name
  description   String?  // Additional description
  balance       Decimal  @db.Decimal(10, 2)
  monthlyPayment Decimal? @db.Decimal(10, 2)
  ownership     String   @default("individual") // "individual", "joint", "spouse"
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  financialData FinancialData @relation(fields: [financialDataId], references: [id], onDelete: Cascade)

  @@map("debts")
}

// Spouse financial data for comparison (user-entered from spouse's affidavit)
model SpouseFinancialRecord {
  id                      String    @id @default(cuid())
  userId                  String
  data                    Json      // { income, expenses, assets, debts } - same shape as FinancialData
  sourceDocumentId        String?   // Optional link to uploaded spouse affidavit PDF
  authorizationConfirmedAt DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("spouse_financial_records")
}

// Legal content (articles, guides, etc.)
model LegalContent {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String   @db.Text
  category    String   // e.g., "process", "requirements", "glossary"
  tags        String[]
  published   Boolean  @default(false)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("legal_content")
}

// Form templates metadata
model FormTemplate {
  id          String   @id @default(cuid())
  name        String
  type        String   // e.g., "petition", "financial_affidavit_short", "financial_affidavit_long"
  description String?
  filePath    String   // Path to template file
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("form_templates")
}

// Children's Information
model Child {
  id              String   @id @default(cuid())
  userId          String
  firstName       String
  lastName        String
  dateOfBirth     DateTime
  gender          String?  // "male", "female", "other", "prefer_not_to_say"
  ssn             String?  // Optional, encrypted in production
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Current information
  currentAddress  String?
  currentSchool   String?
  currentGrade    String?
  currentDoctor   String?
  currentHealthInsurance String?

  // History tracking
  addressHistory  ChildAddressHistory[]
  schoolHistory   ChildSchoolHistory[]
  doctorHistory   ChildDoctorHistory[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("children")
}

// Child address history (for timeline tracking)
model ChildAddressHistory {
  id          String   @id @default(cuid())
  childId     String
  address     String
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean  @default(true)
  createdAt   DateTime @default(now())

  child Child @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@map("child_address_history")
}

// Child school history
model ChildSchoolHistory {
  id          String   @id @default(cuid())
  childId     String
  schoolName  String
  grade       String?
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean  @default(true)
  createdAt   DateTime @default(now())

  child Child @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@map("child_school_history")
}

// Child doctor/healthcare provider history
model ChildDoctorHistory {
  id          String   @id @default(cuid())
  childId     String
  providerName String
  providerType String? // "pediatrician", "dentist", "specialist", etc.
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean  @default(true)
  createdAt   DateTime @default(now())

  child Child @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@map("child_doctor_history")
}

// Parenting Plan
model ParentingPlan {
  id          String   @id @default(cuid())
  userId      String   @unique
  status      String   @default("draft") // "draft", "completed", "filed"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Weekly schedule
  weeklySchedule Json? // Store weekly schedule structure

  // Decision-making authority
  educationAuthority    String? // "parent1", "parent2", "joint"
  healthcareAuthority   String?
  religiousAuthority    String?
  extracurricularAuthority String?

  // Communication protocols
  communicationMethod   String? // "email", "text", "app", "phone"
  communicationFrequency String? // "daily", "weekly", "as_needed"
  communicationNotes    String? @db.Text

  // Special arrangements
  holidays             Json? // Holiday schedule
  summerVacation        Json? // Summer vacation schedule
  schoolBreaks          Json? // School break schedule
  specialOccasions     Json? // Special occasions (birthdays, etc.)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("parenting_plans")
}

// Parent Education Provider
model ParentEducationProvider {
  id          String   @id @default(cuid())
  name        String
  county      String
  format      String   // "online", "in-person", "hybrid"
  cost        Decimal? @db.Decimal(10, 2)
  website     String?
  phone       String?
  email       String?
  address     String?
  description String?  @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  completions ParentEducationCompletion[]

  @@map("parent_education_providers")
}

// Parent Education Completion Tracking
model ParentEducationCompletion {
  id          String   @id @default(cuid())
  userId      String
  providerId  String
  completedAt DateTime
  certificatePath String? // Path to uploaded certificate
  certificateUrl   String? // URL to certificate if stored externally
  notes       String?  @db.Text
  createdAt   DateTime @default(now())

  provider ParentEducationProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("parent_education_completions")
}

// E-Filing Guidance and Instructions
model EFilingGuide {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  category    String   // "setup", "process", "troubleshooting", "county_specific"
  county      String?  // For county-specific guides
  content     String   @db.Text
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("e_filing_guides")
}

// County-specific e-filing information
model CountyEFilingInfo {
  id                String   @id @default(cuid())
  county            String   @unique
  eFilingAvailable  Boolean  @default(true)
  eFilingRequired   Boolean  @default(false)
  portalUrl         String?
  instructions      String?  @db.Text
  specialRequirements String? @db.Text
  contactInfo       Json?    // Phone, email, address
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("county_e_filing_info")
}

// Visitor counter for tracking site visits
model VisitorCount {
  id        String   @id @default(cuid())
  date      DateTime @default(now()) @db.Date
  count     Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date])
  @@map("visitor_counts")
}

// Subscription model for Stripe subscriptions
model Subscription {
  id                String   @id @default(cuid())
  userId            String   @unique
  stripeCustomerId  String?  @unique
  stripeSubscriptionId String? @unique
  stripePriceId     String?
  status            String   // "active", "canceled", "past_due", "trialing", "incomplete", "incomplete_expired"
  plan              String   // "annual", "monthly", etc.
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean @default(false)
  trialStart         DateTime?
  trialEnd           DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// Payment model for payment history
model Payment {
  id                String   @id @default(cuid())
  userId            String
  stripePaymentIntentId String? @unique
  stripeInvoiceId   String? @unique
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("usd")
  status            String   // "succeeded", "pending", "failed", "refunded"
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// Marketing Link for tracking campaigns and influencers
model MarketingLink {
  id          String   @id @default(cuid())
  shortCode   String   @unique  // e.g., "jane-doe", "youtube-explainer-1"
  name        String              // Friendly name for dashboard
  targetUrl   String              // Full URL with UTM params
  utmSource   String              // influencer, youtube, tiktok, facebook, google
  utmMedium   String              // cpc, organic_social, influencer, video
  utmCampaign String              // campaign name
  utmContent  String?             // optional: video title, ad variation
  clicks      Int      @default(0)
  signups     Int      @default(0)
  conversions Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?             // admin user who created it

  @@index([shortCode])
  @@index([utmSource])
  @@index([utmCampaign])
  @@map("marketing_links")
}
